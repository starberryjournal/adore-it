import torch
import torch.nn as nn
import torchvision.transforms as transforms
from torchvision import models
from PIL import Image
import os
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity

# Load the pre-trained ResNet model
resnet = models.resnet18(pretrained=True)
resnet.eval()  # Set the model to evaluation mode

# Remove the final fully connected layer for feature extraction
resnet = nn.Sequential(*list(resnet.children())[:-1])

# Define the image transformations (resize, normalize, etc.)
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
])

# Function to extract features from an image
def extract_features(img_path):
    img = Image.open(img_path).convert("RGB")
    img = transform(img).unsqueeze(0)  # Add batch dimension
    with torch.no_grad():
        features = resnet(img)  # Get features from ResNet
    return features.squeeze().numpy()  # Convert to a numpy array

# Path to your image collection
image_dir = "path_to_your_images"  # Replace with the correct path
image_files = os.listdir(image_dir)

# Extract features for each image in the collection
image_features = []
image_names = []

for img_file in image_files:
    img_path = os.path.join(image_dir, img_file)
    features = extract_features(img_path)
    image_features.append(features)
    image_names.append(img_file)

# Convert the list of features to a NumPy array
image_features = np.array(image_features)

# Now, for the current image (the one the user is viewing)
current_image_path = "path_to_current_image"  # Replace with the current image path
current_image_features = extract_features(current_image_path)

# Calculate cosine similarity between the current image and all others
similarities = cosine_similarity([current_image_features], image_features)

# Get the top 5 most similar images
similar_images_idx = np.argsort(similarities[0])[::-1][:5]
similar_images = [image_names[idx] for idx in similar_images_idx]

print("Most similar images:", similar_images)
